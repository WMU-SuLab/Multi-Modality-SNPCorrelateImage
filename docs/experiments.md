# 实验记录

- 2023-04-11
    - 内容
        - 使用MLP测试了纯SNP预测高度近视
        - 数据集进行了过采样，平衡数据集
    - 结果
        - BCELoss不带sigmoid
        - 未过采样的数据集模型效果不行
        - 过采样的数据集模型效果似乎不错
            - 训练集几乎所有指标都到了1
            - 但是令人怀疑过采样平衡后的数据集是否是影响了模型
            - 或者是数据集并不够多
        - batch normal 比 dropout好
        - 一层隐藏层和两层区别不大，但是一层比没有隐藏层效果好很多
        - 经过组会讨论要重新确定标签，筛选数据集
- 2023-04-12
    - 内容
        - 打乱标签重新测试GeneNet
        - 重新定义了高度近视的标签
    - 结果
        - 打乱标签（实际上是随机标签）后模型在验证集指标上不去，几乎就是完全没效果
            - 似乎可以得到结论：使用SNP直接预测高度近视是可能的，之前效果好的模型没问题
        - 高度近视标签定义如下
            - 现定义标准针对只有SNP数据的情况
            - 根据统计整个数据集人数进行定义，适当放宽了标准
            - 高度近视：任意一只眼小于等于-6D，另一只小于等于-4D，双眼轴长全部大于等于24
            - 非高度近视：双眼全部大于-3D，双眼轴长全部小于等于25
            - 现标准下的标签基本达到了1:1的比例
            - 从原始学生表格中筛选出了4235人
- 2023-04-13
    - 内容
        - 筛选新高度近视标准数据集下的图片
        - 根据新的标准重新筛选SNP
        - 重新对各个数据集和各个文件进行重命名
        - 使用新的位点和新的高度近视标签重新划分数据集、训练GeneNet
    - 结果
        - 在新高度近视标准数据集下，发现两只眼同时通过qc的只有3256多人
        - 在新的标准下（MLMALOCO **<** 0.05）重新筛选SNP，有23785个位点
        - 新的数据训练结果效果很差，基本在0.5左右徘徊
- 2023-04-14
    - 内容
        - 优化训练和测试模块，提供网络参数，可以修改对应训练流程
        - 添加早停法，添加早停模块，添加loss型的早停策略
        - 优化了各个模块的导出，一些函数参数的顺序
        - 在测试模块中增加了对测试数据集是否有数据的判断
- 2023-04-15
    - 内容
        - 正在进行ImageNet的验证
        - 已经完成单眼高度近视和非高度近视人群的划分
- 2023-04-17
    - 内容
        - 完成图片数据集筛选
        - 完善SNPDataset和id交集相关代码，修改其实现方式
- 2023-04-18
    - 内容
        - 制作了周三组会汇报PPT
        - 完成了datasets、workflow、model相关的代码
        - 修正了模型中加载初始化权重方法无效的bug
- 2023-04-19
    - 内容
        - 完成了图片数据集的训练
        - 尝试添加多GPU训练
        - 数据集20230419153742：单眼高度近视
    - 结果
        - 图片数据集训练效果较好，valid 数据集 AUC 可以达到 0.9以上
- 2023-04-20
    - 内容
        - 仔细研究了多GPU训练的方法和流程
        - 基本完成多GPU训练的代码，等待第二天测试
        - 大幅度优化数据集相关代码，使其更加简洁，减少了一半多的无用代码
- 2023-04-21
    - 内容
        - 修复数据集加载时候选择png图片导致没有图片数据的bug
        - 完成单GPU和多GPU的测试
        - 研究了环境变量相关问题
        - 帮助谱希解决问题，完成新的近视遗传辅助诊断API
        - 改善tqdm显示多个进度条的问题
    - 结果
        - 使用多GPU训练效果反而变差了
            - 尝试对指标计算也使用多GPU，效果变好了
            - 但是还是没有单GPU好，还在检查是哪里出现了问题
- 2023-04-25
    - 内容
        - log 20230419171036和log 20230421212831是第一次训练单GPU和多GPU的结果，发现F1指标相差0.06左右
        - 发现处理label的时候，流程上有一些错误，比如有重复的条形码未去除、统计的没有SNP的人包含了数据不规范的人
            - 重新写脚本从头开始进行处理，修复一些bug
        - 根据新增的SNPImageDataset重写整个Dataset代码
        - 重新测试单GPU的效果
            - 数据集：20230419153742
            - log：20230425111228
        - 重新测试多GPU的效果
            - 数据集：20230419153742
            - log：20230425094942
    - 结果
        - 尝试固定随机种子进行训练，重新测试单GPU和多GPU的效果，发现之前单GPU好的效果是偶然的，但是总体来说，单GPU仍然比多GPU好0.03左右
            - 猜测是因为Batch Normalization导致的
- 2023-04-26
    - 内容
        - 根据修复数据处理错误后的重新划分数据集训练，去除了4个人，只验证了图像上的单GPU效果，并在单GPU上重新进行了验证
            - 数据集：20230426194528
            - log
                - 20230426195649：早停为5轮
                - 20230426201848：早停为7轮
        - 重新测试老数据集
            - 数据集：20230419153742
            - log：20230426204033，早停为7轮
            - 再验证log 20230425111228 发现效果就是0.83左右
    - 结果
        - 经过多次训练，发现
            - AUC和F1总是能保持0.8以上，但是其他指标会出现波动
            - 如果早停设置为5，效果似乎比7要差一点
            - 目前单GPU的F1在0.84，多GPU是0.83，似乎相差的就不多了
        - 今天发现图像模型中根本就没加Batch Normalization
            - 再结合老数据集的效果，发现单GPU和多GPU结果基本相近，单GPU并没有更好
            - 可能只是之前把AUC的指标记成0.87了
- 2023-04-26
    - 内容
        - 使用缺少800多人的基因数据集进行基因-图像数据集划分，得到20230426211048，共2439人
        - 在各个文件中导出SNPImageNet相关模型、数据和函数
        - 使用SNPImageNet的backbone进行训练
            - 今天重新检查发现在筛选出来的23785位点中，有21213个位点是文件中能够得到且alleles为2的
        - 成功使用各类CAM对ImageNet的热力图进行分析
    - 结果
        - SNPImageNet效果仅为0.62左右，符合之前使用SNPNet的认知
          - 增加了Batch Normalization，提升到0.73左右